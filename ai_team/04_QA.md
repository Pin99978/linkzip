# QA 工作日誌

### **日期: 2025-09-28**

**工作項目：**

1.  **建立測試環境**
    *   **內容**：安裝了 `pytest` 和 `httpx` 兩個核心測試函式庫。

2.  **撰寫 API 測試案例**
    *   **內容**：在 `tests/test_main.py` 中，針對後端的三個 API 端點，編寫了 6 個核心的測試案例，涵蓋了主要的成功與失敗路徑。
    *   **策略**：採用了資料庫隔離策略，透過覆蓋 FastAPI 的 `get_db` 依賴，為測試使用了獨立的記憶體資料庫，確保了測試的穩定性和可重複性。

3.  **除錯測試執行環境**
    *   **問題 1**：首次執行 `pytest` 時，出現 `ModuleNotFoundError: No module named 'src'`。
    *   **修正 1**：在專案根目錄建立了 `pytest.ini` 檔案，並加入 `pythonpath = .` 設定，讓 `pytest` 能正確找到 `src` 原始碼目錄。
    *   **問題 2**：測試報告 `TypeError`，指出 `allow_redirects` 是無效參數。
    *   **修正 2**：修正了測試程式碼，將錯誤的 `allow_redirects` 參數改為 `TestClient` 正確支援的 `follow_redirects`。

4.  **測試架構升級：遷移至 PostgreSQL 測試**
    *   **動機**：為了確保應用程式與生產環境的資料庫完全相容，需要將測試從 SQLite 遷移到 PostgreSQL。
    *   **初版方案 (失敗)**：嘗試使用 `pytest-docker` 套件來自動化管理測試資料庫容器。
    *   **遭遇問題**：在執行 `pytest` 時，遭遇了多種 `pytest-docker` 的內部錯誤，包括 `command not found` 和 `ValueError: invalid literal for int()`。這顯示該套件在我們的特定環境中行為不穩定。
    *   **最終方案 (成功)**：決定放棄不穩定的 `pytest-docker` 依賴，回歸到更穩定、更透明的手動管理流程。
        1.  **重構測試**：完全重寫 `tests/test_main.py` 的設定部分，移除所有 `pytest-docker` 的 fixture，改為直接連接到一個固定的、預期由 Docker Compose 啟動的資料庫位址 (`localhost:5433`)。
        2.  **建立新流程**：定義了新的三段式測試流程：`docker compose up -d db` -> `pytest` -> `docker compose down`。
        3.  **修正依賴**：在 `requirements.txt` 中補上了遺漏的 `psycopg2-binary` 套件，並在虛擬環境中安裝，解決了 `ModuleNotFoundError`。
    *   **結果**：測試套件最終在連接真實 PostgreSQL 容器的情況下，全部通過。
